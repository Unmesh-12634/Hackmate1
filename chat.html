<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Chat - HackMate</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <a href="javascript:history.back()" class="btn btn-ghost" style="padding: 0.5rem;">
                    <i data-lucide="arrow-left"></i>
                </a>
                <h1 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Team Chat</h1>
                <span id="team-badge" class="badge">Loading...</span>
            </div>
            <div class="nav-actions">
                <button class="btn btn-ghost" onclick="logout()">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>
    </header>

    <div style="height: calc(100vh - 4rem); display: flex; flex-direction: column;">
        <!-- Chat Header -->
        <div style="background: var(--card); border-bottom: 1px solid var(--border); padding: 1rem;">
            <div class="container">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem;">General Chat</h2>
                        <p style="font-size: 0.875rem; color: var(--muted-foreground);" id="member-status">Loading...</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-ghost" title="Video Call">
                            <i data-lucide="video"></i>
                        </button>
                        <button class="btn btn-ghost" title="Voice Call">
                            <i data-lucide="phone"></i>
                        </button>
                        <button class="btn btn-ghost" title="Chat Settings">
                            <i data-lucide="settings"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div style="flex: 1; overflow-y: auto; padding: 1rem; background: var(--muted);" id="chat-messages">
            <!-- Messages will be loaded here -->
        </div>

        <!-- AI Assistant Toggle -->
        <div style="background: var(--card); border-top: 1px solid var(--border); padding: 0.5rem;">
            <div class="container">
                <button class="btn btn-outline" onclick="toggleAIChat()" id="ai-toggle">
                    <i data-lucide="bot"></i>
                    Chat with AI Assistant
                </button>
            </div>
        </div>

        <!-- Message Input -->
        <div style="background: var(--card); border-top: 1px solid var(--border); padding: 1rem;">
            <div class="container">
                <form id="message-form" style="display: flex; gap: 0.5rem; align-items: end;">
                    <div style="flex: 1;">
                        <textarea 
                            id="message-input" 
                            placeholder="Type your message..." 
                            rows="1"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); resize: none; font-family: inherit; background: var(--background);"
                        ></textarea>
                    </div>
                    <button type="button" class="btn btn-ghost" title="Attach File">
                        <i data-lucide="paperclip"></i>
                    </button>
                    <button type="button" class="btn btn-ghost" title="Add Emoji">
                        <i data-lucide="smile"></i>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="ai-chat-modal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 600px; height: 80%; margin: 2rem auto; display: flex; flex-direction: column;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
                <div>
                    <h2 class="card-title">AI Assistant</h2>
                    <p class="card-description">Get help with your project</p>
                </div>
                <button class="btn btn-ghost" onclick="toggleAIChat()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div style="flex: 1; overflow-y: auto; padding: 1rem;" id="ai-chat-messages">
                <div class="ai-message">
                    <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="width: 2rem; height: 2rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="bot" style="width: 1rem; height: 1rem; color: var(--primary-foreground);"></i>
                        </div>
                        <div style="flex: 1; background: var(--muted); padding: 0.75rem; border-radius: var(--radius);">
                            <p>Hello! I'm your AI assistant. I can help you with:</p>
                            <ul style="margin: 0.5rem 0; padding-left: 1rem;">
                                <li>Code review and debugging</li>
                                <li>Project planning and task breakdown</li>
                                <li>Technology recommendations</li>
                                <li>Design feedback and suggestions</li>
                            </ul>
                            <p>What would you like help with today?</p>
                        </div>
                    </div>
                </div>
            </div>
            <div style="border-top: 1px solid var(--border); padding: 1rem;">
                <form id="ai-message-form" style="display: flex; gap: 0.5rem;">
                    <input 
                        type="text" 
                        id="ai-message-input" 
                        placeholder="Ask the AI assistant..." 
                        style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--background);"
                    >
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="send"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Check authentication
        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'login.html';
        }

        let currentUser = JSON.parse(localStorage.getItem('user'));
        let currentTeam = null;
        let messages = [];
        let aiMessages = [];
        let isAIChatOpen = false;

        function getTeamId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('team');
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        }

        function loadTeamData() {
            const teamId = getTeamId();
            if (!teamId) {
                window.location.href = 'teams.html';
                return;
            }

            currentTeam = currentUser.teams?.find(t => t.id.toString() === teamId);
            if (!currentTeam) {
                window.location.href = 'teams.html';
                return;
            }

            // Update page elements
            document.getElementById('team-badge').textContent = currentTeam.name;
            const memberCount = currentTeam.members?.length || 1;
            document.getElementById('member-status').textContent = `${memberCount} member${memberCount !== 1 ? 's' : ''} online`;

            loadMessages();
        }

        function loadMessages() {
            // Get messages from localStorage or create sample messages
            const chatKey = `chat_${currentTeam.id}`;
            messages = JSON.parse(localStorage.getItem(chatKey)) || generateSampleMessages();
            
            renderMessages();
        }

        function generateSampleMessages() {
            const now = new Date();
            return [
                {
                    id: 1,
                    sender: 'System',
                    message: `Welcome to ${currentTeam.name} chat! ðŸŽ‰`,
                    timestamp: new Date(now.getTime() - 3600000).toISOString(),
                    type: 'system'
                },
                {
                    id: 2,
                    sender: currentUser.name,
                    message: 'Hey everyone! Excited to work on this project together!',
                    timestamp: new Date(now.getTime() - 1800000).toISOString(),
                    type: 'user'
                },
                {
                    id: 3,
                    sender: 'Alice Johnson',
                    message: 'Great! I\'ve started working on the UI mockups. Will share them soon.',
                    timestamp: new Date(now.getTime() - 900000).toISOString(),
                    type: 'other'
                },
                {
                    id: 4,
                    sender: 'Bob Smith',
                    message: 'Perfect! I\'ll handle the backend API. Let me know what endpoints you need.',
                    timestamp: new Date(now.getTime() - 300000).toISOString(),
                    type: 'other'
                }
            ];
        }

        function renderMessages() {
            const chatContainer = document.getElementById('chat-messages');
            
            chatContainer.innerHTML = messages.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                if (msg.type === 'system') {
                    return `
                        <div style="text-align: center; margin: 1rem 0;">
                            <span style="background: var(--muted); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; color: var(--muted-foreground);">
                                ${msg.message}
                            </span>
                        </div>
                    `;
                }
                
                const isCurrentUser = msg.sender === currentUser.name;
                const alignment = isCurrentUser ? 'flex-end' : 'flex-start';
                const bgColor = isCurrentUser ? 'var(--primary)' : 'var(--card)';
                const textColor = isCurrentUser ? 'var(--primary-foreground)' : 'var(--foreground)';
                
                return `
                    <div style="display: flex; justify-content: ${alignment}; margin-bottom: 1rem;">
                        <div style="max-width: 70%;">
                            ${!isCurrentUser ? `<div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem; color: var(--muted-foreground);">${msg.sender}</div>` : ''}
                            <div style="background: ${bgColor}; color: ${textColor}; padding: 0.75rem; border-radius: var(--radius); ${isCurrentUser ? 'border-bottom-right-radius: 0.25rem;' : 'border-bottom-left-radius: 0.25rem;'}">
                                ${msg.message}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; text-align: ${isCurrentUser ? 'right' : 'left'};">
                                ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage(messageText) {
            if (!messageText.trim()) return;
            
            const newMessage = {
                id: Date.now(),
                sender: currentUser.name,
                message: messageText,
                timestamp: new Date().toISOString(),
                type: 'user'
            };
            
            messages.push(newMessage);
            
            // Save to localStorage
            const chatKey = `chat_${currentTeam.id}`;
            localStorage.setItem(chatKey, JSON.stringify(messages));
            
            renderMessages();
            
            // Auto-scroll to bottom
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function toggleAIChat() {
            isAIChatOpen = !isAIChatOpen;
            const modal = document.getElementById('ai-chat-modal');
            modal.style.display = isAIChatOpen ? 'block' : 'none';
            
            if (isAIChatOpen) {
                document.getElementById('ai-message-input').focus();
            }
        }

        function sendAIMessage(messageText) {
            if (!messageText.trim()) return;
            
            // Add user message
            const userMessage = {
                id: Date.now(),
                sender: 'user',
                message: messageText,
                timestamp: new Date().toISOString()
            };
            
            aiMessages.push(userMessage);
            renderAIMessages();
            
            // Simulate AI response
            setTimeout(() => {
                const aiResponse = generateAIResponse(messageText);
                const aiMessage = {
                    id: Date.now() + 1,
                    sender: 'ai',
                    message: aiResponse,
                    timestamp: new Date().toISOString()
                };
                
                aiMessages.push(aiMessage);
                renderAIMessages();
            }, 1000);
        }

        function generateAIResponse(userMessage) {
            const responses = [
                "That's a great question! For your hackathon project, I'd recommend focusing on the core features first and then adding enhancements.",
                "Based on your project requirements, here's what I suggest: 1. Set up your development environment, 2. Create a basic MVP, 3. Add key features incrementally.",
                "I can help you break that down into smaller tasks. What specific aspect would you like to tackle first?",
                "For a hackathon timeline, I recommend using an agile approach with short sprints. This will help you stay focused and deliver results quickly.",
                "That's an interesting technical challenge! Have you considered using modern frameworks that can speed up development?",
                "Great progress! For the next steps, I suggest focusing on user experience and making sure your solution addresses the core problem effectively."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function renderAIMessages() {
            const aiChatContainer = document.getElementById('ai-chat-messages');
            
            const userMessages = aiMessages.filter(msg => msg.sender === 'user').map(msg => `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <div style="background: var(--primary); color: var(--primary-foreground); padding: 0.75rem; border-radius: var(--radius); border-bottom-right-radius: 0.25rem; max-width: 80%;">
                        ${msg.message}
                    </div>
                </div>
            `).join('');
            
            const aiResponses = aiMessages.filter(msg => msg.sender === 'ai').map(msg => `
                <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="width: 2rem; height: 2rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i data-lucide="bot" style="width: 1rem; height: 1rem; color: var(--primary-foreground);"></i>
                    </div>
                    <div style="background: var(--muted); padding: 0.75rem; border-radius: var(--radius); border-bottom-left-radius: 0.25rem; flex: 1;">
                        ${msg.message}
                    </div>
                </div>
            `).join('');
            
            // Preserve the initial AI message and add new messages
            const initialMessage = aiChatContainer.querySelector('.ai-message').outerHTML;
            let allMessages = [initialMessage];
            
            // Interleave user and AI messages chronologically
            const sortedMessages = [...aiMessages].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            sortedMessages.forEach(msg => {
                if (msg.sender === 'user') {
                    allMessages.push(`
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                            <div style="background: var(--primary); color: var(--primary-foreground); padding: 0.75rem; border-radius: var(--radius); border-bottom-right-radius: 0.25rem; max-width: 80%;">
                                ${msg.message}
                            </div>
                        </div>
                    `);
                } else {
                    allMessages.push(`
                        <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="width: 2rem; height: 2rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i data-lucide="bot" style="width: 1rem; height: 1rem; color: var(--primary-foreground);"></i>
                            </div>
                            <div style="background: var(--muted); padding: 0.75rem; border-radius: var(--radius); border-bottom-left-radius: 0.25rem; flex: 1;">
                                ${msg.message}
                            </div>
                        </div>
                    `);
                }
            });
            
            aiChatContainer.innerHTML = allMessages.join('');
            
            // Re-initialize icons and scroll to bottom
            lucide.createIcons();
            aiChatContainer.scrollTop = aiChatContainer.scrollHeight;
        }

        // Handle message form submission
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('message-input');
            const messageText = messageInput.value.trim();
            
            if (messageText) {
                sendMessage(messageText);
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        });

        // Handle AI message form submission
        document.getElementById('ai-message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const aiMessageInput = document.getElementById('ai-message-input');
            const messageText = aiMessageInput.value.trim();
            
            if (messageText) {
                sendAIMessage(messageText);
                aiMessageInput.value = '';
            }
        });

        // Auto-resize textarea
        document.getElementById('message-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Handle Enter key in message input
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('message-form').dispatchEvent(new Event('submit'));
            }
        });

        // Close AI modal when clicking outside
        document.getElementById('ai-chat-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleAIChat();
            }
        });

        // Load team data on page load
        loadTeamData();
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            max-height: 90vh;
            overflow: hidden;
        }

        /* Custom scrollbar */
        #chat-messages::-webkit-scrollbar,
        #ai-chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        #chat-messages::-webkit-scrollbar-track,
        #ai-chat-messages::-webkit-scrollbar-track {
            background: var(--muted);
        }

        #chat-messages::-webkit-scrollbar-thumb,
        #ai-chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        #chat-messages::-webkit-scrollbar-thumb:hover,
        #ai-chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--muted-foreground);
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95% !important;
                height: 85% !important;
            }
        }
    </style>
</body>
</html>
