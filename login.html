<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login - HackMate</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
</head>
<body class="auth-page">

  <div class="auth-container">
    <div class="auth-header">
      <a href="index.html" class="nav-brand">
        <div class="nav-logo"><i data-lucide="zap"></i></div>
        <span class="nav-title">HackMate</span>
      </a>
      <h1>Welcome Back</h1>
      <p>Sign in with Google to continue.</p>
    </div>

    <div class="card">
      <div class="card-content">
        <!-- Google Login Button -->
        <button type="button" class="btn btn-outline btn-full" onclick="signInWithGoogle()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          Sign in with Google
        </button>

        <div class="auth-switch" style="margin-top: 1.5rem;">
          <span>Don't have an account? </span>
          <a href="signup.html" class="link">Sign up</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // 🔧 Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCYV3V0KhHjGcQhmH3Dsg9Se2PFOf5G0qY",
      authDomain: "hackmate-f9127.firebaseapp.com",
      databaseURL: "https://hackmate-f9127-default-rtdb.firebaseio.com",
      projectId: "hackmate-f9127",
      storageBucket: "hackmate-f9127.appspot.com",
      messagingSenderId: "617200538584",
      appId: "1:617200538584:web:0204c1ce29dbe8caf798ad",
      measurementId: "G-XDMK184368"
    };

    // 🚀 Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // 🟢 Login
    async function signInWithGoogle() {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Save/merge user profile
        await setDoc(
          doc(db, "users", user.uid),
          {
            name: user.displayName || "",
            email: user.email || "",
            avatar: user.photoURL || "",
            uid: user.uid,
            joinedAt: serverTimestamp()
          },
          { merge: true }
        );

        // Go to dashboard
        window.location.replace("teams.html");

      } catch (error) {
        console.error("Sign-In Error:", error.code, error.message);
        alert("Error signing in: " + error.message);
      }
    }

    // 🔴 Logout
    async function logout() {
      try {
        await signOut(auth);
        window.location.replace("login.html"); // ✅ fixed
      } catch (error) {
        console.error("Sign Out Error:", error);
      }
    }

    // 🔐 Route Guard
    onAuthStateChanged(auth, (user) => {
     const protectedPages = ["teams.html", "profile.html", "resources.html"];
const authPages = ["login.html", "signup.html", "index.html"];

if (!user && protectedPages.includes(path)) {
  window.location.replace("login.html");
} else if (user && authPages.includes(path)) {
  window.location.replace("teams.html");
}
        const path = (window.location.pathname.split("/").pop() || "index.html").toLowerCase();
    
        if (!user && protectedPages.includes(path)) {
            if (path !== "login.html") window.location.replace("login.html");
        } else if (user && authPages.includes(path)) {
            if (path !== "teams.html") window.location.replace("teams.html");
        }

    });

    window.signInWithGoogle = signInWithGoogle;
    window.logout = logout;
  </script>

  <!-- Lucide Icons -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) lucide.createIcons();
    });
  </script>
</body>
</html>
